<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Setflow - Calendar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="toast.css">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; }
    .loading-spinner { display: inline-block; width: 1.5rem; height: 1.5rem; border: 3px solid rgba(255, 255, 255, 0.1); border-radius: 50%; border-top-color: #10B981; animation: spin 0.8s linear infinite; }
    .ambient-light { position: absolute; top: 0; left: 0; right: 0; height: 60%; background: radial-gradient(circle at 50% 30%, rgba(16, 185, 129, 0.1), transparent 70%); pointer-events: none; z-index: 0; }
    /* Nav Styles */
    .bottom-nav-link { display: flex; flex-direction: column; align-items: center; justify-content: center; flex-grow: 1; padding: 0.5rem 0; font-size: 0.75rem; font-weight: 500; color: #A3A3A3; transition: color 0.15s ease-in-out; width: 100%; }
    .bottom-nav-link:hover { color: white; }
    /* Active state color handled by JS */
    .bottom-nav-link svg { margin-bottom: 0.25rem; display: block; margin-left: auto; margin-right: auto; }
  </style>
</head>
<body class="text-white antialiased">
<div class="mx-auto flex min-h-screen max-w-md flex-col relative z-10 bg-neutral-900">
  <div id="offline-banner" style="display:none" class="bg-red-600 text-white text-center text-sm p-2">Offline Mode</div>
  <div class="ambient-light"></div>

  <header class="fixed top-0 left-0 right-0 z-20 mx-auto h-16 max-w-md border-b border-white/10 bg-black/80 backdrop-blur-md px-4 backdrop-blur-sm">
    <div class="flex h-full items-center justify-between">
      <a href="#" onclick="window.history.back(); return false;" class="p-2 rounded-full text-neutral-400 hover:text-white btn-press">
        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
      </a>
      <h1 class="flex-grow text-center text-lg font-bold tracking-tight text-emerald-400">Calendar</h1>
      <div class="w-10"></div> </div>
  </header>

  <main class="flex-grow p-5 pt-20 pb-24 relative z-10"> 
    <section>
        <h2 class="mb-3 text-xs font-bold uppercase tracking-wider text-neutral-500">Upcoming Events</h2>
        <div id="upcoming-events-container" class="space-y-3">
            <div class="flex justify-center items-center py-10" id="loading-state">
                <div class="loading-spinner"></div>
            </div>
             <div class="hidden py-10 text-center glass-card rounded-xl" id="empty-state">
                <h3 class="mt-2 text-lg font-semibold text-white">No Events</h3>
                <p class="mt-1 text-sm text-neutral-400">Your schedule is clear.</p>
            </div>
        </div>
    </section>
  </main>

  <a id="calendar-fab" href="#" class="fixed bottom-20 left-1/2 -translate-x-1/2 z-40 flex h-14 w-14 items-center justify-center rounded-full bg-emerald-500 text-white shadow-lg shadow-emerald-500/40 btn-press hover:bg-emerald-400 border-2 border-neutral-900">
      <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
  </a>

  <nav class="fixed bottom-0 left-0 right-0 z-30 mx-auto max-w-md border-t border-white/10 bg-black/90 backdrop-blur-xl pb-safe">
    <div id="bottom-nav-container" class="flex h-16 items-center justify-around"></div>
  </nav>
</div> 

<div id="toast-notification" class="fixed bottom-20 left-1/2 z-[9999] max-w-[90%] -translate-x-1/2 transform rounded-xl px-6 py-3 text-center text-base text-white shadow-lg opacity-0 transition-opacity duration-300 ease-in-out">
  <span id="toast-message"></span>
</div>
<script src="toast.js"></script>
<script src="nav.js"></script>

<script type="module">
    import { onAuthState, fetchCalendarEvents, gracefulGet, isOnline, escapeHTML, getUserData, navigation } from './api.js';
    
    window.goBackOr = navigation.goBackOr;
    const container = document.getElementById('upcoming-events-container');
    const loading = document.getElementById('loading-state');
    const empty = document.getElementById('empty-state');
    const fab = document.getElementById('calendar-fab');

    if(!isOnline()) document.getElementById('offline-banner').style.display = 'block';

    // 1. Instant Load Menu
    const cachedRole = localStorage.getItem('setflow_role') || 'musician';
    if(window.renderBottomNav) window.renderBottomNav(cachedRole, 'free', 'setflow-calendar.html');

    // 2. Configure FAB based on role
    if (cachedRole === 'venue' || cachedRole === 'promoter') {
        fab.href = 'setflow-post-event-page.html'; // Venue creates Gigs
        fab.classList.replace('bg-emerald-500', 'bg-indigo-500'); // Use Venue Color
        fab.classList.replace('shadow-emerald-500/40', 'shadow-indigo-500/40');
    } else {
        fab.href = 'setflow-new-calendar-event.html'; // Musician creates Blocks/Rehearsals
    }

    function renderEvents(events) {
        loading.style.display = 'none';
        if (!events || events.length === 0) {
            empty.style.display = 'block';
            return;
        }
        empty.style.display = 'none';
        container.innerHTML = ''; // Clear loading

        events.forEach((event, index) => {
            const div = document.createElement('div');
            div.className = 'glass-card flex items-center justify-between rounded-xl p-4 mb-3 animate-enter hover:bg-white/5 transition';
            div.style.animationDelay = `${index * 0.05}s`;
            
            let colorClass = 'text-neutral-400';
            let typeLabel = event.type || 'Event';

            if (event.source === 'gig') {
                colorClass = 'text-indigo-400';
                typeLabel = 'My Gig';
            } else if (event.type === 'gig') {
                 colorClass = 'text-emerald-400'; // Booked gig for musician
            }

            // Link logic: Gigs go to management, Events go to edit?
            let linkHtml = '';
            if (event.source === 'gig') {
                linkHtml = `<a href="setflow-post-event-page.html?gigId=${event.id}" class="ml-2 text-xs bg-white/10 px-3 py-1 rounded-lg hover:bg-white/20 text-white">Manage</a>`;
            } else if (event.type === 'gig') {
                linkHtml = `<a href="setflow-show-sheet.html?gigId=${event.gigId}" class="ml-2 text-xs bg-white/10 px-3 py-1 rounded-lg hover:bg-white/20 text-white">Sheet</a>`;
            }

            div.innerHTML = `
                <div class="flex-1 min-w-0">
                    <p class="truncate text-sm font-semibold text-white">${escapeHTML(event.title)}</p>
                    <div class="flex items-center mt-1 space-x-2">
                         <span class="text-[10px] uppercase font-bold px-1.5 py-0.5 rounded bg-white/5 ${colorClass}">${typeLabel}</span>
                         <span class="truncate text-xs text-neutral-500">${event.formattedDate} â€¢ ${event.formattedTime}</span>
                    </div>
                </div>
                ${linkHtml}
            `;
            container.appendChild(div);
        });
    }

    onAuthState(async (user) => {
        if (user) {
            // Refresh Data
            const userData = await gracefulGet(getUserData(user.uid));
            
            // Ensure nav is synced if role changed
            if(userData && userData.roles) {
                const realRole = userData.roles[0];
                if(realRole !== cachedRole) {
                    localStorage.setItem('setflow_role', realRole);
                    if(window.renderBottomNav) window.renderBottomNav(realRole, userData.subscriptionTier, 'setflow-calendar.html');
                     // Update FAB if role mismatch found late
                     if (realRole === 'venue') fab.href = 'setflow-post-event-page.html';
                }
            }
            
            const events = await gracefulGet(fetchCalendarEvents(user.uid));
            renderEvents(events);
        } else {
            window.location.href = 'setflow-login-page.html';
        }
    });
</script>
</body>
</html>