<!DOCTYPE html>
<html lang="en">
<head>
    <title>Setflow - Conversation</title>
</head>
<body class="bg-neutral-900 text-white antialiased">
  <div id="offline-banner">You are currently offline.</div>
  
  <div class="mx-auto flex min-h-screen max-w-md flex-col bg-neutral-900 text-white">
    <main id="messages-container" class="flex-1 space-y-4 overflow-y-auto px-4 pt-20 pb-40"> 
      <div class="flex justify-center items-center py-10" id="loading-state">
        <div class="loading-spinner"></div>
      </div>
      <div class="hidden py-10 text-center" id="empty-state">
          <p class="text-sm text-neutral-500">No messages yet. Say hello!</p>
      </div>
    </main>

    <footer class="fixed bottom-0 left-0 right-0 z-30 mx-auto max-w-md border-t border-neutral-700 bg-neutral-900/90 p-4 backdrop-blur-sm">
      <form id="message-form" class="flex items-center space-x-2 rounded-xl border border-neutral-700 bg-neutral-800 p-2">
        <input id="message-input" type="text" placeholder="Type a message" class="flex-1 border-0 bg-transparent px-2 py-1 text-sm text-white placeholder-neutral-500 outline-none focus:ring-0"/>
        <button id="send-btn" type="submit" class="rounded-lg bg-emerald-600 px-4 py-1.5 text-sm font-semibold text-white transition-colors hover:bg-emerald-500">Send</button>
      </form>
    </footer>
  </div>

  <div id="toast-notification" class="fixed bottom-28 left-1/2 z-[9999] max-w-[90%] -translate-x-1/2 transform rounded-xl px-6 py-3 text-center text-base text-white shadow-lg opacity-0 transition-opacity duration-300 ease-in-out">
    <span id="toast-message">Placeholder</span>
  </div>
  
  <script src="toast.js"></script>
  
  <script type="module">
    import { renderHeader } from './components.js';
    import { onAuthState, getUserData, createOrGetConversation, sendMessage, getMessages, escapeHTML, isOnline } from './api.js';

    // 1. Initialize UI Components
    // Default back link is inbox, but renderHeader uses goBackOr() logic
    renderHeader('Conversation', 'setflow-inbox.html');
    
    const messagesContainer = document.getElementById('messages-container');
    const messageInput = document.getElementById('message-input');
    const loadingState = document.getElementById('loading-state');
    const emptyState = document.getElementById('empty-state');
    
    const urlParams = new URLSearchParams(window.location.search);
    const recipientId = urlParams.get('recipientId');
    
    let currentUserId = null;
    let conversationId = null;

    function renderMessages(messages) {
        loadingState.style.display = 'none';
        messagesContainer.innerHTML = ''; // Clear loading/empty

        if (messages.length === 0) {
            emptyState.style.display = 'block';
            messagesContainer.appendChild(emptyState);
            return;
        }
        
        const frag = document.createDocumentFragment();
        messages.forEach(msg => {
            const isSender = msg.senderId === currentUserId;
            const div = document.createElement('div');
            div.className = `mb-2 flex ${isSender ? 'justify-end' : 'justify-start'}`;
            
            // SECURITY: escapeHTML protects against XSS
            div.innerHTML = `
                <div class="max-w-[80%]">
                    <div class="inline-block rounded-2xl border px-3 py-2 text-sm ${isSender ? 'bg-emerald-700/30 border-emerald-600/40 text-emerald-100' : 'bg-neutral-800/60 border-neutral-700/70 text-neutral-100'}">
                        ${escapeHTML(msg.text)} 
                    </div>
                </div>
            `;
            frag.appendChild(div);
        });
        messagesContainer.appendChild(frag);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    document.getElementById('message-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = messageInput.value.trim();
        if(!text || !conversationId) return;

        const originalText = messageInput.value;
        messageInput.value = ''; // Optimistic clear
        
        try {
            await sendMessage(conversationId, { text, senderId: currentUserId });
        } catch(err) {
            console.error(err);
            window.toast.show("Failed to send", "error");
            messageInput.value = originalText; // Restore on fail
        }
    });

    onAuthState(async (user) => {
        if(user) {
            currentUserId = user.uid;
            // Fetch recipient name for header title if needed, or just 'Conversation'
            try {
                const recipient = await getUserData(recipientId);
                if(recipient && recipient.name) {
                    document.querySelector('h1').textContent = recipient.name;
                }
            } catch(e) { console.warn("Could not load recipient name"); }

            conversationId = await createOrGetConversation(currentUserId, recipientId);
            getMessages(conversationId, renderMessages);
        } else {
            window.location.href = 'setflow-login-page.html';
        }
    });
  </script>
</body>
</html>