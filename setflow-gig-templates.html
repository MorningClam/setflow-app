<!DOCTYPE html>
<html lang="en">
<head>
  <title>Setflow - Gig Templates</title>
</head>
<body class="bg-neutral-900 text-white antialiased">
<div id="offline-banner">You are currently offline. Templates cached.</div>

<div class="mx-auto flex min-h-screen max-w-md flex-col bg-neutral-900 text-white">
  <main id="template-list" class="flex-1 space-y-3 p-5 pt-20 pb-20"> 
    <div class="flex justify-center items-center py-10" id="loading-state">
      <div class="loading-spinner"></div>
    </div>
    <div class="hidden py-10 text-center" id="empty-state">
      <h3 class="mt-2 text-lg font-semibold text-white">No Templates Saved</h3>
      <p class="mt-1 text-sm text-neutral-400">Create a gig to save it as a template.</p>
    </div>
    <div class="hidden py-10 text-center text-red-400" id="error-state">
        <p>Could not load gig templates.</p>
    </div>
  </main>

  <nav class="fixed bottom-0 left-0 right-0 z-30 mx-auto max-w-md border-t border-neutral-700 bg-neutral-800/90 backdrop-blur-sm">
      <div id="bottom-nav-container" class="flex h-16 items-center justify-around"></div>
  </nav>
</div> 

<div id="toast-notification" class="fixed bottom-20 left-1/2 z-[9999] max-w-[90%] -translate-x-1/2 transform rounded-xl px-6 py-3 text-center text-base text-white shadow-lg opacity-0 transition-opacity duration-300 ease-in-out">
 <span id="toast-message">Placeholder</span>
</div>
<script src="toast.js"></script>
<script src="nav.js"></script>

<script type="module">
     import { renderHeader } from './components.js';
     import { onAuthState, gracefulGet, isOnline, getUserData, fetchGigTemplates, escapeHTML } from './api.js';

     // 1. Render UI
     // Determine back link based on role, but safe default is history
     renderHeader("Gig Templates", "history");

     const templateContainer = document.getElementById('template-list');
     const loadingState = document.getElementById('loading-state');
     const emptyState = document.getElementById('empty-state');
     const errorState = document.getElementById('error-state');
     const offlineBanner = document.getElementById('offline-banner');

     if(!isOnline()) offlineBanner.style.display = 'block';

     function renderTemplates(templates) {
         loadingState.style.display = 'none';
         
         if (!templates) {
             errorState.style.display = 'block';
             return;
         }

         if (templates.length === 0) {
             emptyState.style.display = 'block';
             return;
         }

         // Clear previous content just in case
         templateContainer.innerHTML = ''; 

         templates.forEach(template => {
             const templateCard = document.createElement('div');
             templateCard.className = 'template-item flex items-center justify-between rounded-lg bg-neutral-800 p-4 hover:bg-neutral-700 transition-colors border border-neutral-700 mb-3';

             const payout = template.payout ? `$${template.payout} â€¢ ` : '';
             const genres = (template.genres && template.genres.length > 0) ? template.genres.join(', ') : 'No genre';

             templateCard.innerHTML = `
                 <div class="flex-1 min-w-0">
                     <p class="font-semibold text-white truncate">${escapeHTML(template.name)}</p>
                     <p class="text-xs text-neutral-400 truncate">${escapeHTML(payout + genres)}</p>
                 </div>
                 <a href="setflow-post-event-page.html?templateId=${template.id}" class="ml-2 flex-shrink-0 rounded-xl bg-emerald-600 px-4 py-1.5 text-xs font-semibold text-white transition-colors hover:bg-emerald-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">Use</a>
             `;
              templateContainer.appendChild(templateCard);
         });
     }

     onAuthState(async (user) => {
         if (user) { 
             try {
                 const userData = await gracefulGet(getUserData(user.uid));
                 // Update Bottom Nav based on Role
                 let role = 'promoter';
                 if(userData?.roles?.includes('venue')) role = 'venue';
                 if(window.renderBottomNav) window.renderBottomNav(role, 'free', 'setflow-gig-templates.html');

                 const templates = await gracefulGet(fetchGigTemplates(user.uid));
                 renderTemplates(templates);

             } catch (error) {
                 console.error("Error loading templates:", error);
                 renderTemplates(null);
             }
         } else {
             window.location.href = 'setflow-login-page.html';
         }
     });
 </script>
</body>
</html>