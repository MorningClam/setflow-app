<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://cdn.tailwindcss.com; connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://*.firebaseio.com wss://*.firebaseio.com https://*.functions.cloud.google.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' data: https://fonts.gstatic.com; img-src 'self' data: https://images.unsplash.com; frame-src 'self' https://*.firebaseapp.com https://accounts.google.com; object-src 'none'; base-uri 'self'; form-action 'self';">
  <title>Setflow - Review Applicants</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="toast.css"> <style>
    body{font-family:'Inter',sans-serif}
    #offline-banner {
      display: none; /* Hidden by default */
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      padding: 0.5rem;
      background-color: #dc2626; /* red-600 */
      color: white;
      text-align: center;
      font-size: 0.875rem;
      font-weight: 500;
      z-index: 9999;
    }
  </style>
</head>
<body class="bg-neutral-900 text-white antialiased">
  <div id="offline-banner">You are currently offline. Some features may be unavailable.</div>
  <div class="max-w-md mx-auto bg-neutral-900 min-h-screen flex flex-col pt-10">
    <header class="px-3 py-4 bg-neutral-800/80 backdrop-blur-sm fixed top-0 left-0 right-0 max-w-md mx-auto z-20 flex justify-between items-center shadow-md border-b border-neutral-700/50">
      <a href="setflow-venue-dashboard.html" aria-label="Go back to dashboard" class="p-2 rounded-full hover:bg-neutral-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 focus:ring-offset-neutral-900"><svg class="w-6 h-6 text-neutral-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></a>
      <div id="header-title" class="text-center flex-grow"> <h1 class="text-lg font-bold tracking-tight">Review Applicants</h1>
        </div>
      <div class="w-9 h-9"></div> </header>
    <div class="px-5 py-3 border-b border-neutral-800 pt-20"> <label for="sort" class="text-xs text-neutral-400 mr-2">Sort by:</label>
        <select id="sort" class="bg-neutral-700 text-white text-sm rounded-md p-1 border-0 focus:outline-none focus:ring-2 focus:ring-emerald-500">
            <option>Best Match</option>
            <option>Newest</option>
            </select>
    </div>

    <main id="applicants-container" class="flex-grow pb-28 divide-y divide-neutral-800">
       <div class="loading-spinner-container"><div class="loading-spinner"></div></div>
    </main>

  </div>

  <script type="module">
    import { onAuthState, fetchApplicantsForGig, gracefulGet, ui } from './api.js'; // Import gracefulGet and ui

    const applicantsContainer = document.getElementById('applicants-container');
    const headerTitle = document.getElementById('header-title');
    const urlParams = new URLSearchParams(window.location.search);
    const gigId = urlParams.get('gigId');
    const gigName = urlParams.get('gigName') || 'a Gig';

    // Update header to be more descriptive
    headerTitle.innerHTML = `<h1 class="text-lg font-bold tracking-tight">Applicants for</h1><p class="text-sm text-neutral-400">${decodeURIComponent(gigName)}</p>`;

    // Show initial loading spinner (already in HTML)
    // ui.loading.show(applicantsContainer);

    function renderApplicants(applicants) {
      // gracefulGet handles the loading spinner removal on success or error display
      if (!applicants) {
          // Error handled by gracefulGet
           if (!applicantsContainer.innerHTML.includes('Error') && !applicantsContainer.innerHTML.includes('offline')) {
                applicantsContainer.innerHTML = `<p class="p-4 text-center text-red-400 mt-8">Could not load applicants.</p>`;
           }
          return;
      }

      // Clear container before rendering (gracefulGet might have put spinner/error)
      applicantsContainer.innerHTML = '';

      if (applicants.length === 0) {
        applicantsContainer.innerHTML = `<p class="p-4 text-center text-neutral-500 mt-8">No one has applied to this gig yet.</p>`;
        return;
      }


      applicants.forEach(applicant => {
        const applicantCard = document.createElement('div');
        // Added focus styles to the main link wrapper
        applicantCard.className = 'p-4 hover:bg-neutral-800/50 focus-within:bg-neutral-800/50 focus-within:outline-none focus-within:ring-2 focus-within:ring-inset focus-within:ring-emerald-500 rounded'; // Use focus-within
        // Pass gigId and applicant name to profile link for booking context
        const profileLink = `setflow-applicant-profile.html?userId=${applicant.id}&gigId=${gigId}&artistName=${encodeURIComponent(applicant.name)}`;
        applicantCard.innerHTML = `
          <a href="${profileLink}" class="flex items-center space-x-4 group rounded focus:outline-none"> <img class="w-16 h-16 rounded-lg object-cover flex-shrink-0" src="${applicant.profileImageUrl || 'https://images.unsplash.com/photo-1516280440614-376394488883?q=80&w=2187&auto=format&fit=crop'}" alt="${applicant.name}">
            <div class="flex-1 min-w-0">
              <p class="font-bold text-lg text-white truncate group-hover:text-emerald-400">${applicant.name}</p>
              <p class="text-sm text-neutral-300 truncate">${applicant.genres ? applicant.genres.join(', ') : 'Music'}</p>
              </div>
             <span aria-hidden="true" class="text-neutral-500 group-hover:text-emerald-400">â†’</span>
          </a>
          <div class="flex items-center space-x-2 mt-3">
              <a href="setflow-conversation-view.html?recipientId=${applicant.id}" class="w-full text-center py-2 bg-neutral-700 hover:bg-neutral-600 text-white text-xs font-bold rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 focus:ring-offset-neutral-800">Message</a>
              <button class="w-full py-2 bg-neutral-700 hover:bg-neutral-600 text-white text-xs font-bold rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 focus:ring-offset-neutral-800">Bookmark</button>
          </div>
        `;
        applicantsContainer.appendChild(applicantCard);
      });
    }

    onAuthState(async (user) => {
      if (user) {
        if (!gigId) {
          applicantsContainer.innerHTML = '<p class="p-4 text-red-400">Error: No Gig ID provided in the URL.</p>';
          return;
        }
        try {
          // Use gracefulGet to fetch applicants, passing the container for loading/error state
          const applicants = await gracefulGet(fetchApplicantsForGig(gigId), applicantsContainer, "Could not load applicants while offline.");
          // Render only if fetch succeeded (gracefulGet returns data)
          renderApplicants(applicants); // Handles null response

        } catch (error) {
          // Error already displayed by gracefulGet
          console.error("Failed to fetch applicants (already handled by gracefulGet):", error);
        }
      } else {
        window.location.href = 'setflow-login-page.html';
      }
    });
  </script>
   <div id="toast-notification" class="opacity-0"> <span id="toast-message">Placeholder message</span>
   </div>
   <script src="toast.js"></script> </body>
</html>